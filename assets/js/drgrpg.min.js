var DRGRPG=function($){"use strict";var heartBeat,pendingTranslation,initialized=!1,turnTimeout=3e3,config={constants:{processingBarHeight:50},playerStatsToShow:["attack","defense","xp","gold"],language:{mainMenu_Map:"Map",mainMenu_Combat:"Combat",mainMenu_Items:"Items",mainMenu_Skills:"Skills",mainMenu_Achievements:"Achievements",fleeButton:"Flee Battle",huntMonsters:"Hunt for Monsters",noMonstersToHunt:"Nothing to Hunt",achievementsHeader:"Your Achievements",haveNewAchievements:"{{number}} New Achievements!",unearnedAchievement:"---",skillsHeader:"Your Skills",guildLevelLabel:"Rank {{level}} {{name}}",roomObjects_examine_header:"Examine:",roomObjects_action_header:"Take Action:",roomObjects_npc_header:"Talk To:",roomObjects_exits_header:"Move:",entireRoom:"entire room",roomObjectList_examine_header:"Examine:",roomObjectList_examine_description:"Examining ",roomObjectList_action_header:"Take Action:",roomObjectList_action_description:"Attempting action ",roomObjectList_npc_header:"Talk to:",roomObjectList_npc_description:"Talking to ",pauseGame:"Pause Game",unpauseGame:"Unpause Game",playerHPLabel:"HP: ",playerMPLabel:"MP: ",playerStats_str:"STR: ",playerStats_dex:"DEX: ",playerStats_int:"INT: ",playerStats_attack:"Attack: ",playerStats_defense:"Defense: ",playerStats_xp:"XP: ",playerStats_gold:"Gold: ",enemyHPLabel:"HP: ",dismissNotification:"click to dismiss this notice",processingActions:"Processing actions...Minimum wait between turns of 3 seconds",processingError:"Error contacting server. Attempting again...",combatRecapTitle:"Recap of Previous Battle:",noCombatResultsYet:"No battle results yet received since you loaded the game.",monsterDefeated:["{{name}} was defeated. You receive {{xp}} XP and {{gold}} gold.","You beat {{name}} and receive {{xp}} XP and {{gold}} gold for your violence...I mean efforts."],playerDefeated:"You were defeated by {{monster}} but manage to escape.",playerFleeBattle:"You flee the battle!",dropConfirmation:"Are you sure you want to drop your ",emptyInventory:"You don't have any items in your inventory.",inventoryTitle:"Your Inventory",equipmentSlotsTitle:"Your Equipment Slots",equipmentSlotLabels_helmet:"Helmet: ",equipmentSlotLabels_necklace:"Necklace: ",equipmentSlotLabels_bodyarmor:"Bodyarmor: ",equipmentSlotLabels_back:"Back: ",equipmentSlotLabels_weapon:"Weapon: ",equipmentSlotLabels_shield:"Shield: ",equipmentSlotLabels_leggings:"Leggings: ",equipmentSlotLabels_boots:"Boots: ",itemLabels_attack:"Attack: ",itemLabels_defense:"Defense: ",unequipItemLink:"unequip",equipItemLink:"equip",dropItemLink:"drop"}},first_turn=!0,executingTurn=!1,showingProcessingBar=!1,currentProcessingBarMessage="processingActions",cached={},turnsSinceLastAction=0,paused=!1,currentlyViewing="Room",interactingWith="",actionsToTake=[["system","first-turn"]],actionsTaken=[],mainMenu=[["Map","showRoom","","drgrpg-mainMenu__map","drgrpg-mainMenu__button drgrpg-mainMenu__button--active drgrpg-mainMenu__map"],["Combat","showCombat","","drgrpg-mainMenu__combat","drgrpg-mainMenu__button drgrpg-mainMenu__combat"],["Items","showItems","","drgrpg-mainMenu__items","drgrpg-mainMenu__button drgrpg-mainMenu__items"],["Skills","showSkills","","drgrpg-mainMenu__skills","drgrpg-mainMenu__button drgrpg-mainMenu__skills"],["Achievements","showAchievements","","drgrpg-mainMenu__achievements","drgrpg-mainMenu__button drgrpg-mainMenu__achievements"]],player={},room={},combat={},combatResults=[],equipmentSlots=["helmet","necklace","bodyarmor","back","weapon","shield","leggings","boots"],notifications=[],unviewedAchievements={},hooks={},cacheSelectors=function(){cached.playerStats=document.getElementById("drgrpg-playerStats"),cached.$playerStats=$(cached.playerStats),cached.mainMenu=document.getElementById("drgrpg-mainMenu"),cached.$mainMenu=$(cached.mainMenu),cached.$playerIdentity=$(document.getElementById("drgrpg-playerIdentity")),cached.$body=$(document.getElementsByTagName("body")[0]),cached.$lookingAt=$(document.getElementById("drgrpg-lookingAt")),cached.notifications=document.getElementById("drgrpg-notifications"),cached.$notifications=$(cached.notifications),cached.$processingBar=$(document.getElementById("drgrpg-processingBar"))},addMissingElements=function(){0===cached.$mainMenu.length&&(cached.$lookingAt.before('<div id="drgrpg-mainMenu" class="drgrpg-mainMenu"></div>'),cached.$mainMenu=$(document.getElementById("drgrpg-mainMenu"))),0===cached.$playerStats.length&&(cached.$lookingAt.after('<br><div id="drgrpg-playerInfo" class="drgrpg-playerInfo"><div id="drgrpg-playerIdentity" class="drgrpg-playerIdentity"></div><div id="drgrpg-playerStats" class="drgrpg-playerStats">Loading player stats...</div></div>'),cached.$playerStats=$(document.getElementById("drgrpg-playerStats")),cached.$playerIdentity=$(document.getElementById("drgrpg-playerIdentity")))},fillElementsWithText=function(){cached.$processingBar.html(getText("processingActions"))},executeTurn=function(){return clearTimeout(heartBeat),heartBeat=null,executingTurn=!0,paused||0===actionsToTake.length&&player.hp>=player.max_hp&&player.mp>=player.max_mp&&!combat.round?(turnsSinceLastAction+=1,heartBeat=setTimeout(executeTurn,turnTimeout),void(executingTurn=!1)):(actionsTaken=actionsToTake.slice(0),$.ajax(infoFromServer.siteURL+"/game/api/turn/",{type:"POST",success:function(data){processDataReceived(data),hideProcessingBar(),removeActionsTaken(),turnsSinceLastAction=0,heartBeat=setTimeout(executeTurn,turnTimeout),first_turn=!1,pendingTranslation&&processTranslation(),doAction("successfulTurn")},error:function(){changeProcessingBarMessage("processingError"),showProcessingBar("processingError"),heartBeat=setTimeout(executeTurn,turnTimeout),doAction("failedTurn")},data:{action:actionsToTake,security:infoFromServer.nonce}}),void(executingTurn=!1))},processDataReceived=function(data){if(data){if(data.playerStats&&(processStatsData(data.playerStats),displayPlayerStats()),data.playerSkills&&(processSkillsData(data.playerSkills[0]),addNoticeToMenuItem("Skills")),data.playerGuild&&(player.guild=data.playerGuild[0]),data.updatePlayerGuild&&(player.guild=data.updatePlayerGuild[0],displayPlayerIdentity()),data.playerIdentity&&(player.name=data.playerIdentity[0].name,player.avatar=data.playerIdentity[0].avatar,displayPlayerIdentity()),data.room&&(processroomData(data.room),"Room"===currentlyViewing?displayRoom():addNoticeToMenuItem("Room")),data.roomUpdate&&(processroomData(data.roomUpdate),updateRoom()),data.playerEquipment&&!data.playerInventory&&(processEquipmentData(data.playerEquipment[0]),"Items"===currentlyViewing?displayItems():first_turn||addNoticeToMenuItem("Items")),data.playerInventory&&(processInventoryData(data.playerInventory[0]),data.playerEquipment&&processEquipmentData(data.playerEquipment[0]),"Items"===currentlyViewing?displayItems():first_turn||addNoticeToMenuItem("Items")),data.clearInventory&&(player.inventory=null,displayItems()),data.notifications&&(processNotificationsData(data.notifications),displayNotifications()),data.new_combat&&(first_turn&&(paused=!0,first_turn=!1),combatResults=[],processCombatData(data.new_combat),changeViewing("Combat"),displayCombat()),data.fleeCombat&&(combatResults.push(["playerFlee",getText("playerFleeBattle")]),endCombat(),displayRoom(),enableMenuItem("Room")),data.combat)if(processCombatData(data.combat),data.combat[0].playerDefeated){var defeatMessage=getText("playerDefeated").replace("{{monster}}",data.combat[0].playerDefeated[0]);combatResults.push(["playerDefeated",defeatMessage]),endCombat(),displayCombatButNoBattle(),enableMenuItem("Room")}else data.combat[0].endCombat?(endCombat(),enableMenuItem("Room"),"Combat"===currentlyViewing?displayCombatButNoBattle():addNoticeToMenuItem("Combat")):(displayCombat(!0),"Combat"!==currentlyViewing&&addNoticeToMenuItem("Combat"));data.newAchievement&&(processAchievementData(data.newAchievement[0],"new"),"Achievements"===currentlyViewing?displayAchievements():addNoticeToMenuItem("Achievements")),data.achievements&&processAchievementData(data.achievements[0]),data.pause&&(paused=!0)}},processAchievementData=function(data,update){player.achievements||(player.achievements={});var notification=0;for(var number in data)data.hasOwnProperty(number)&&(player.achievements[number]=data[number],update&&(notification=1,unviewedAchievements[number]=1,addNotification("achievement","<b>New Achievement: "+data[number][0]+"</b><br>"+data[number][1])));notification&&displayNotifications()},processCombatData=function(data){var subObj,i,j,len,jlen,parsingVariables;for(var obj in data)if(data.hasOwnProperty(obj)){subObj=data[obj];for(var key in subObj)subObj.hasOwnProperty(key)&&(combat[key]=subObj[key])}if(combat.playerSkillUsed)for(i=0,len=combat.playerSkillUsed.length;len>i;i++)combatResults.push(["playerSkillUsed","(round "+(combat.round-1)+") "+combat.playerSkillUsed[i]]);if(combat.playerSkillUsed=null,combat.results)for(i=0,len=combat.results[0].length;len>i;i++)for(var msgType in combat.results[0][i])if(combat.results[0][i].hasOwnProperty(msgType))for(j=0,jlen=combat.results[0][i][msgType].length;jlen>j;j++)"monsterDefeated"===msgType?(parsingVariables=getText("monsterDefeated"),parsingVariables=parsingVariables.replace("{{name}}",combat.results[0][i][msgType][j][0]),parsingVariables=parsingVariables.replace("{{xp}}",addCommas(combat.results[0][i][msgType][j][1])),parsingVariables=parsingVariables.replace("{{gold}}",addCommas(combat.results[0][i][msgType][j][2])),combatResults.push(["monsterDefeated","(round "+(combat.round-1)+") "+parsingVariables])):combatResults.push([msgType,"(round "+(combat.round-1)+") "+combat.results[0][i][msgType][j]]);combat.results=null},processStatsData=function(data){var oldHP=player.hp;for(var obj in data)if(data.hasOwnProperty(obj)){var subObj=data[obj];for(var key in subObj)subObj.hasOwnProperty(key)&&(player[key]=subObj[key])}oldHP&&(oldHP<player.hp?doAction("playerHealed"):oldHP>player.hp&&doAction("playerHurt"))},processSkillsData=function(data){player.skills={};for(var skillName in data)data.hasOwnProperty(skillName)&&(player.skills[skillName]=data[skillName])},processNotificationsData=function(data){for(var i=0,len=data.length;len>i;i++)notifications.push([(new Date).getTime(),data[i][0],data[i][1]])},addNotification=function(type,message){notifications.push([(new Date).getTime(),type,message])},displayNotifications=function(){var container,message,dismissLink,i,fragment=document.createDocumentFragment(),len=notifications.length;if(0===len)return void fadeHTMLFragment(cached.$notifications,fragment);for(i=0;len>i;i++)container=createActionElement("div",null,"dismissNotification",[notifications[i][0],notifications[i][2]]),container.id="drgrpg-notifications__message--"+notifications[i][0],container.className="drgrpg-notifications__message"+(notifications[i][1]?" drgrpg-notifications__message--"+notifications[i][1]:""),message=document.createElement("p"),message.className="drgrpg-notifications__message__text",message.innerHTML=notifications[i][2],container.appendChild(message),dismissLink=document.createElement("a"),dismissLink.innerHTML=getText("dismissNotification"),dismissLink.href="#/",dismissLink.className="drgrpg-notifications__dismissLink",container.appendChild(dismissLink),fragment.appendChild(container);fadeHTMLFragment(cached.$notifications,fragment)},removeNotification=function(time,message){for(var i=0,len=notifications.length;len>i;i++)if(time===notifications[i][0]&&message===notifications[i][2]){notifications.splice(i,1);break}displayNotifications()},processInventoryData=function(data){var alreadyInInventory,i,j,len,jlen;for(player.inventoryCount=[],player.inventory=[],i=0,len=data.length;len>i;i++)data[i]=JSON.stringify(data[i]);for(i=0,len=data.length;len>i;i++){for(alreadyInInventory=!1,j=0,jlen=player.inventory.length;jlen>j;j++)if(data[i]===player.inventory[j]){alreadyInInventory=j;break}!1===alreadyInInventory?(player.inventory.push(data[i]),player.inventoryCount.push(1)):player.inventoryCount[alreadyInInventory]+=1}for(i=0,len=player.inventory.length;len>i;i++)player.inventory[i]=JSON.parse(player.inventory[i])},processEquipmentData=function(data){player.equippedItems=data},displayPlayerIdentity=function(){var span,guildTitle,fragment=document.createDocumentFragment();fragment.appendChild(convertStringToFragment(player.avatar)),span=document.createElement("span"),span.className="drgrpg-playerName",span.innerHTML=player.name,fragment.appendChild(span),player.guild&&player.guild.name&&(span=document.createElement("span"),span.className="drgrpg-playerGuild",guildTitle=getText("guildLevelLabel"),guildTitle=guildTitle.replace("{{level}}",player.guild.level),guildTitle=guildTitle.replace("{{name}}",player.guild.name),span.innerHTML=guildTitle,fragment.appendChild(span)),fadeHTMLFragment(cached.$playerIdentity,fragment)},displayMainMenu=function(){var i,len,fragment=document.createDocumentFragment();for(i=0,len=mainMenu.length;len>i;i++)fragment.appendChild(createActionElement("button",getText("mainMenu_"+mainMenu[i][0]),mainMenu[i][1],mainMenu[i][2],mainMenu[i][3],mainMenu[i][4]));for(emptyElement(cached.mainMenu),cached.mainMenu.appendChild(sanitizeFragment(fragment)),i=0;len>i;i++)cached["$"+mainMenu[i][1]]=$(document.getElementById(mainMenu[i][3]))},displayPlayerStats=function(){var dl,dt,dd,hp,hpContainer,hpLabel,hpNumber,hpValue,mp,mpContainer,mpLabel,mpNumber,mpValue,hpPercentage,mpPercentage,fragment=document.createDocumentFragment();hpContainer=document.createElement("div"),hpContainer.className="drgrpg-playerHPContainer",hp=document.createElement("div"),hp.className="drgrpg-playerHP",hpPercentage=Math.round(player.hp/player.max_hp*100),hp.style.width=hpPercentage+"%",hpContainer.appendChild(hp),hpNumber=document.createElement("div"),hpNumber.className="drgrpg-playerHPNumber",hpLabel=document.createElement("span"),hpLabel.className="drgrpg-playerHPNumber__label",hpLabel.innerHTML=getText("playerHPLabel"),hpNumber.appendChild(hpLabel),hpValue=document.createElement("span"),hpValue.className="drgrpg-playerHPNumber__value",hpValue.innerHTML=player.hp+" / "+player.max_hp,hpNumber.appendChild(hpValue),hpContainer.appendChild(hpNumber),fragment.appendChild(hpContainer),mpContainer=document.createElement("div"),mpContainer.className="drgrpg-playerMPContainer",mp=document.createElement("div"),mp.className="drgrpg-playerMP",mpPercentage=Math.round(player.mp/player.max_mp*100),mp.style.width=mpPercentage+"%",mpContainer.appendChild(mp),mpNumber=document.createElement("div"),mpNumber.className="drgrpg-playerMPNumber",mpLabel=document.createElement("span"),mpLabel.className="drgrpg-playerMPNumber__label",mpLabel.innerHTML=getText("playerMPLabel"),mpNumber.appendChild(mpLabel),mpValue=document.createElement("span"),mpValue.className="drgrpg-playerMPNumber__value",mpValue.innerHTML=player.mp+" / "+player.max_mp,mpNumber.appendChild(mpValue),mpContainer.appendChild(mpNumber),fragment.appendChild(mpContainer),dl=document.createElement("dl"),dl.className="drgrpg-playerStats__list";for(var i=0,len=config.playerStatsToShow.length;len>i;i++)dt=document.createElement("dt"),dt.innerHTML=getText("playerStats_"+config.playerStatsToShow[i]),dt.className="drgrpg-playerStats__label drgrpg-playerStats__"+config.playerStatsToShow[i]+"__label",dl.appendChild(dt),dd=document.createElement("dd"),dd.innerHTML=addCommas(player[config.playerStatsToShow[i]]),dd.className="drgrpg-playerStats__value drgrpg-playerStats__"+config.playerStatsToShow[i]+"__value",dl.appendChild(dd);fragment.appendChild(dl),sanitizeFragment(fragment),emptyElement(cached.playerStats),cached.playerStats.appendChild(fragment)},processroomData=function(data){var oldRoom=room.id;for(var obj in data)if(data.hasOwnProperty(obj)){var subObj=data[obj];for(var key in subObj)subObj.hasOwnProperty(key)&&(room[key]=subObj[key])}oldRoom&&oldRoom!==room.id?(doAction("playerMoved"),interactingWith=""):oldRoom&&doAction("roomUpdated"),groupRoomObjects()},groupRoomObjects=function(){room.actionObjects=[],room.examineObjects=[],room.npcObjects=[];for(var i=0,len=room.objects.length;len>i;i++)switch(room.objects[i].group){case"action":room.actionObjects.push(room.objects[i]);break;case"examine":room.examineObjects.push(room.objects[i]);break;case"npc":room.npcObjects.push(room.objects[i])}},displayRoom=function(){var roomExits,roomActions,fragment=document.createDocumentFragment();setRoomEnvironment(room.environment),fragment.appendChild(generateRoomDescription()),roomActions=document.createElement("div"),roomActions.id="drgrpg-roomActions",room.className="drgrpg-roomActions",room.examineObjects.length>0&&room.examineObjects[0].description&&roomActions.appendChild(generateRoomObjects("examine",room.examineObjects)),room.actionObjects.length>0&&roomActions.appendChild(generateRoomObjects("action",room.actionObjects)),room.npcObjects.length>0&&roomActions.appendChild(generateRoomObjects("npc",room.npcObjects)),room.exits.length>0&&(roomExits=generateRoomExits(),roomExits&&roomActions.appendChild(roomExits)),roomActions.appendChild(generateHuntButton()),fragment.appendChild(roomActions),fadeHTMLFragment(cached.$lookingAt,fragment,function(){cacheRoomDescription(),changeViewing("Room")})},updateRoom=function(){var fragment=document.createDocumentFragment();setRoomEnvironment(room.environment),room.examineObjects.length>0&&fragment.appendChild(generateRoomObjects("examine",room.examineObjects)),room.actionObjects.length>0&&fragment.appendChild(generateRoomObjects("action",room.actionObjects)),room.npcObjects.length>0&&fragment.appendChild(generateRoomObjects("npc",room.npcObjects)),room.exits.length>0&&fragment.appendChild(generateRoomExits(room.exits)),fragment.appendChild(generateHuntButton()),fadeHTMLFragment(cached.$lookingAt.find(document.getElementById("drgrpg-roomActions")),fragment,function(){cacheRoomDescription(),"Room"!==currentlyViewing&&addNoticeToMenuItem("Room")})},cacheRoomDescription=function(){cached.$roomDescription=$(document.getElementById("drgrpg-roomDescription"))},generateRoomDescription=function(){var div=document.createElement("div");return div.id="drgrpg-roomDescription",div.className="drgrpg-roomDescription",div.appendChild(getCurrentDescription()),div},generateRoomObjects=function(objectType,objects){if(objects){var li,fragment=document.createDocumentFragment(),ul=document.createElement("ul"),header=document.createElement("h4");header.innerHTML=getText("roomObjects_"+objectType+"_header"),header.className="drgrpg-roomActions__header drgrpg-roomActions__"+objectType+"__header",fragment.appendChild(header),ul.id="drgrpg-roomActions__"+objectType,ul.className="drgrpg-roomActions__list drgrpg-roomActions__"+objectType+"__list","examine"===objectType&&(li=document.createElement("li"),li.className="drgrpg-roomActions__list__item",li.appendChild(createActionElement("a",getText("entireRoom"),"interactWithRoomObject",["entireRoom",getText("roomObjectList_"+objectType+"_description")])),ul.appendChild(li));for(var obj in objects)if(objects.hasOwnProperty(obj)){var subObj=objects[obj];li=document.createElement("li"),li.className="drgrpg-roomActions__list__item",li.appendChild(createActionElement("a",subObj.name,"interactWithRoomObject",[subObj.name,getText("roomObjectList_"+objectType+"_description")])),ul.appendChild(li)}return fragment.appendChild(ul),fragment}},generateRoomExits=function(){if(0===room.exits.length)return!1;var li,fragment=document.createDocumentFragment(),ul=document.createElement("ul"),header=document.createElement("h4");header.innerHTML=getText("roomObjects_exits_header"),header.className="drgrpg-roomActions__header drgrpg-roomActions__exit__header",fragment.appendChild(header),ul.id="drgrpg-roomActions__exit",ul.className="drgrpg-roomActions__list drgrpg-roomActions__exit__list";for(var obj in room.exits)if(room.exits.hasOwnProperty(obj)){var exit=room.exits[obj];li=document.createElement("li"),li.className="drgrpg-roomActions__list__item",li.appendChild(createActionElement("a",exit.link,"movePlayer",exit.link)),ul.appendChild(li)}return fragment.appendChild(ul),fragment},generateHuntButton=function(){var button;return room.monsters?button=createActionElement("button",getText("huntMonsters"),"huntButton","","drgrpg-huntButton","drgrpg-huntButton"):(button=createActionElement("button",getText("noMonstersToHunt"),"","","drgrpg-huntButton","drgrpg-huntButton--noHunting"),button.disabled=!0),button},interactWithRoomObject=function(withWhat,textToShow){var frag,actionDescription;if("entireRoom"===withWhat)return interactingWith="",frag=convertStringToFragment(room.description),fadeHTMLFragment(cached.$roomDescription,frag),void scrollIntoView();for(var obj in room.objects)if(room.objects.hasOwnProperty(obj)){var subObj=room.objects[obj];if(withWhat===subObj.name){subObj.action&&executeAction("roomObjectAction",subObj.name),frag=document.createDocumentFragment(),actionDescription=document.createElement("h4"),actionDescription.innerHTML=textToShow+subObj.name+"...",frag.appendChild(actionDescription),frag.appendChild(convertStringToFragment(subObj.description)),fadeHTMLFragment(cached.$roomDescription,frag),interactingWith=frag.cloneNode(!0),scrollIntoView();break}}},scrollIntoView=function(){$("html, body").animate({scrollTop:cached.$mainMenu.offset().top-100},"fast"),$("html, body").scrollTop()},getCurrentDescription=function(){return""!==interactingWith?interactingWith.cloneNode(!0):convertStringToFragment(room.description)},setRoomEnvironment=function(environment){cached.$body.removeClass(function(index,css){return(css.match(/(^|\s)drgrpg-environment-\S+/g)||[]).join(" ")}).addClass("drgrpg-environment-"+environment)},createEnemiesFragment=function(){var ul,li,thisEnemy,enemyName,hpContainer,hp,hpNumber,hpLabel,hpValue,hpPercentage,enemyImage;ul=document.createElement("ul"),ul.id="drgrpg-enemies",ul.className="drgrpg-enemies";for(var i=0,len=combat.enemies[0].length;len>i;i++)thisEnemy=combat.enemies[0][i],li=document.createElement("li"),li.id="drgrpg-enemy__"+i,li.className="drgrpg-enemy drgrpg-enemy__"+i,0===thisEnemy.hp&&(li.className+=" drgrpg-enemy--defeated"),enemyName=document.createElement("div"),enemyName.className="drgrpg-enemy__name",enemyName.innerHTML=thisEnemy.name,li.appendChild(enemyName),hpContainer=document.createElement("div"),hpContainer.className="drgrpg-enemyHPContainer",hp=document.createElement("div"),hp.className="drgrpg-enemyHP",hpPercentage=Math.round(thisEnemy.hp/thisEnemy.max_hp*100),hp.style.width=hpPercentage+"%",hpContainer.appendChild(hp),hpNumber=document.createElement("div"),hpNumber.className="drgrpg-enemyHPNumber",hpLabel=document.createElement("span"),hpLabel.className="drgrpg-enemyHPNumber__label",hpLabel.innerHTML=getText("enemyHPLabel"),hpNumber.appendChild(hpLabel),hpValue=document.createElement("span"),hpValue.className="drgrpg-enemyHPNumber__value",hpValue.innerHTML=thisEnemy.hp+" / "+thisEnemy.max_hp,hpNumber.appendChild(hpValue),hpContainer.appendChild(hpNumber),li.appendChild(hpContainer),thisEnemy.image&&(enemyImage=document.createElement("img"),enemyImage.src=thisEnemy.image,enemyImage.className="drgrpg-enemy__image",li.appendChild(enemyImage)),ul.appendChild(li);return ul},createCombatSkillsFragment=function(){var header,ul,li,fragment=document.createDocumentFragment(),skillsFound=0;ul=document.createElement("ul"),ul.className="drgrpg-combatSkills";for(var skillName in player.skills)player.skills.hasOwnProperty(skillName)&&(li=document.createElement("li"),li.className="drgrpg-combatSkills__skill",li.appendChild(createActionElement("a",skillName,"use_skill",skillName)),ul.appendChild(li),skillsFound+=1);return skillsFound>0&&(header=document.createElement("h3"),header.innerHTML="Use a Skill:",header.className="drgrpg-combatSkills__header",fragment.appendChild(header)),fragment.appendChild(ul),fragment},displayCombat=function(update){var combatButtons,fragment=document.createDocumentFragment();combatButtons=document.createElement("div"),combatButtons.className="drgrpg-combatButtons",combatButtons.appendChild(generatePauseButton()),combatButtons.appendChild(createActionElement("button",getText("fleeButton"),"fleeButton","","drgrpg-fleeButton","drgrpg-combatButtons__button drgrpg-fleeButton")),fragment.appendChild(combatButtons),fragment.appendChild(createCombatSkillsFragment()),fragment.appendChild(createEnemiesFragment()),update?(emptyElement(cached.enemies),cached.enemies.appendChild(sanitizeFragment(createEnemiesFragment()))):fadeHTMLFragment(cached.$lookingAt,fragment,function(){changeViewing("Combat"),disableMenuItem("Room"),cached.enemies=document.getElementById("drgrpg-enemies"),cached.$pauseButton=$(document.getElementById("drgrpg-pauseButton"))})},displayCombatButNoBattle=function(){var combatButtons,resultsTitle,results,message,i,len,fragment=document.createDocumentFragment();if(combatButtons=document.createElement("div"),combatButtons.className="drgrpg-combatButtons",combatButtons.appendChild(generateHuntButton()),fragment.appendChild(combatButtons),results=document.createElement("div"),results.className="drgrpg-combatResults",resultsTitle=document.createElement("h3"),resultsTitle.className="drgrpg-combatResults__header",resultsTitle.innerHTML=getText("combatRecapTitle"),results.appendChild(resultsTitle),len=combatResults.length,len>0)for(i=0;len>i;i++)message=document.createElement("p"),message.className="drgrpg-combatResults__message drgrpg-combatResults__message--"+combatResults[i][0],message.innerHTML=combatResults[i][1],results.appendChild(message);else message=document.createElement("p"),message.className="drgrpg-combatResults__message",message.innerHTML=getText("noCombatResultsYet"),results.appendChild(message);fragment.appendChild(results),fadeHTMLFragment(cached.$lookingAt,fragment,function(){changeViewing("Combat")})},endCombat=function(){combat={}},displayItems=function(){var h3,ul,li,span,link,i,len,fragment=document.createDocumentFragment();for(h3=document.createElement("h3"),h3.className="drgrpg-equipmentList__header",h3.innerHTML=getText("equipmentSlotsTitle"),fragment.appendChild(h3),ul=document.createElement("ul"),ul.className="drgrpg-equipmentList",i=0,len=equipmentSlots.length;len>i;i++)li=document.createElement("li"),li.className="drgrpg-equipmentList__item drgrpg-equipmentList__item__"+equipmentSlots[i],span=document.createElement("span"),span.className="drgrpg-equipmentList__item__slot",span.innerHTML=getText("equipmentSlotLabels_"+equipmentSlots[i]),li.appendChild(span),player.equippedItems[equipmentSlots[i]].name&&(span=document.createElement("span"),span.className="drgrpg-equipmentList__item__name",span.innerHTML+=player.equippedItems[equipmentSlots[i]].name+" - ",li.appendChild(span)),player.equippedItems[equipmentSlots[i]].attack&&(span=document.createElement("span"),span.className="drgrpg-equipmentList__item__stats__label drgrpg-equipmentList__item__stats__attack__label",span.innerHTML=getText("itemLabels_attack"),li.appendChild(span),span=document.createElement("span"),span.className="drgrpg-equipmentList__item__stats__value drgrpg-equipmentList__item__stats__attack__value",span.innerHTML=player.equippedItems[equipmentSlots[i]].attack,li.appendChild(span)),player.equippedItems[equipmentSlots[i]].defense&&(span=document.createElement("span"),span.className="drgrpg-equipmentList__item__stats__label drgrpg-equipmentList__item__stats__defense__label",span.innerHTML=getText("itemLabels_defense"),li.appendChild(span),span=document.createElement("span"),span.className="drgrpg-equipmentList__item__stats__value drgrpg-equipmentList__item__stats__defense__value",span.innerHTML=player.equippedItems[equipmentSlots[i]].defense,li.appendChild(span)),player.equippedItems[equipmentSlots[i]]&&(link=createActionElement("a",getText("unequipItemLink"),"unequip_item",player.equippedItems[equipmentSlots[i]]),link.className="drgrpg-equipmentList__item__link drgrpg-equipmentList__item__unequip",li.appendChild(link)),ul.appendChild(li);if(fragment.appendChild(ul),player.inventory){for(h3=document.createElement("h3"),h3.className="drgrpg-itemsList__header",h3.innerHTML=getText("inventoryTitle"),fragment.appendChild(h3),ul=document.createElement("ul"),ul.className="drgrpg-itemsList",i=0,len=player.inventory.length;len>i;i++)li=document.createElement("li"),li.className="drgrpg-itemsList__item",player.inventoryCount[i]>1&&(span=document.createElement("span"),span.className="drgrpg-itemsList__item__count",span.innerHTML=player.inventoryCount[i]+"x",li.appendChild(span)),span=document.createElement("span"),span.className="drgrpg-itemsList__item__name",span.innerHTML=player.inventory[i].name+" ("+player.inventory[i].type+") - ",li.appendChild(span),player.inventory[i].attack&&(span=document.createElement("span"),span.className="drgrpg-itemsList__item__stats__label drgrpg-itemsList__item__stats__attack__label",span.innerHTML=getText("itemLabels_attack"),li.appendChild(span),span=document.createElement("span"),span.className="drgrpg-itemsList__item__stats__value drgrpg-itemsList__item__stats__attack__value",span.innerHTML=player.inventory[i].attack,li.appendChild(span)),player.inventory[i].defense&&(span=document.createElement("span"),span.className="drgrpg-itemsList__item__stats__label drgrpg-itemsList__item__stats__defense__label",span.innerHTML=getText("itemLabels_defense"),li.appendChild(span),span=document.createElement("span"),span.className="drgrpg-itemsList__item__stats__value drgrpg-itemsList__item__stats__defense__value",span.innerHTML=player.inventory[i].defense,li.appendChild(span)),link=createActionElement("a",getText("equipItemLink"),"equip_item",player.inventory[i]),link.className="drgrpg-itemsList__item__link drgrpg-itemsList__item__equip",li.appendChild(link),link=createActionElement("a",getText("dropItemLink"),"drop_item",player.inventory[i]),link.className="drgrpg-itemsList__item__link drgrpg-itemsList__item__drop",li.appendChild(link),ul.appendChild(li);fragment.appendChild(ul)}else h3=document.createElement("h3"),h3.className="drgrpg-itemsList__header",h3.innerHTML=getText("emptyInventory"),fragment.appendChild(h3);fadeHTMLFragment(cached.$lookingAt,fragment,changeViewing("Items"))},displaySkills=function(){var ul,li,header,fragment=document.createDocumentFragment();header=document.createElement("h3"),header.className="drgrpg-skillList__header",header.innerHTML=getText("skillsHeader"),fragment.appendChild(header),ul=document.createElement("ul"),ul.className="drgrpg-skillList";for(var skillName in player.skills)player.skills.hasOwnProperty(skillName)&&(li=document.createElement("li"),li.className="drgrpg-skillList__skill",li.innerHTML=skillName+" - level "+player.skills[skillName],ul.appendChild(li));fragment.appendChild(ul),fadeHTMLFragment(cached.$lookingAt,fragment,changeViewing("Skills"))},displayAchievements=function(){var i,len,dt,dd,header,hasNewText,hasNew,fragment=document.createDocumentFragment(),dl=document.createElement("dl"),howManyNew=0;for(header=document.createElement("h3"),header.className="drgrpg-achievementList__header",header.innerHTML=getText("achievementsHeader"),fragment.appendChild(header),i=0,len=unviewedAchievements.length;len>i;i++)unviewedAchievements[i]&&(howManyNew+=1);howManyNew>0&&(hasNew=document.createElement("h4"),hasNewText=getText("haveNewAchievements"),hasNew.innerHTML=hasNewText.replace("{{number}}",howManyNew),fragment.appendChild(hasNew)),dl.className="drgrpg-achievementList";for(var number in player.achievements)player.achievements.hasOwnProperty(number)&&(unviewedAchievements[number]?(dt=document.createElement("dt"),dt.className="drgrpg-achievementList__name drgrpg-achievementList__name--new",dt.innerHTML=player.achievements[number][0],dl.appendChild(dt),dd=document.createElement("dd"),dd.className="drgrpg-achievementList__content drgrpg-achievementList__content--new",dd.innerHTML=player.achievements[number][1],dl.appendChild(dd)):player.achievements[number][1]?(dt=document.createElement("dt"),dt.className="drgrpg-achievementList__name",
dt.innerHTML=player.achievements[number][0],dl.appendChild(dt),dd=document.createElement("dd"),dd.className="drgrpg-achievementList__content",dd.innerHTML=player.achievements[number][1],dl.appendChild(dd)):(dt=document.createElement("dt"),dt.className="drgrpg-achievementList__name drgrpg-achievementList__name--unearned",dt.innerHTML=player.achievements[number][0],dl.appendChild(dt),dd=document.createElement("dd"),dd.className="drgrpg-achievementList__content drgrpg-achievementList__content--unearned",dd.innerHTML=getText("unearnedAchievement"),dl.appendChild(dd)));fragment.appendChild(dl),fadeHTMLFragment(cached.$lookingAt,fragment,changeViewing("Achievements")),unviewedAchievements=[]},changeViewing=function(newView){cached["$show"+currentlyViewing].removeClass("drgrpg-mainMenu__button--active"),cached["$show"+newView].removeClass("drgrpg-mainMenu__button--notice").addClass("drgrpg-mainMenu__button--active"),currentlyViewing=newView},disableMenuItem=function(item){cached["$show"+item].addClass("drgrpg-mainMenu__button--disabled")},enableMenuItem=function(item){cached["$show"+item].removeClass("drgrpg-mainMenu__button--disabled")},addNoticeToMenuItem=function(item){cached["$show"+item].addClass("drgrpg-mainMenu__button--notice")},showProcessingBar=function(){!0!==showingProcessingBar&&(showingProcessingBar=!0,cached.$processingBar.animate({top:"0"}))},hideProcessingBar=function(){!1!==showingProcessingBar&&cached.$processingBar.animate({top:"-"+(config.constants.processingBarHeight+50)},400,function(){showingProcessingBar=!1,changeProcessingBarMessage()})},changeProcessingBarMessage=function(message){message||"processingActions"===currentProcessingBarMessage?"processingError"===message&&"processingError"!==currentProcessingBarMessage&&(cached.$processingBar.html(getText("processingError")).addClass("drgrpg-processingBar--error"),currentProcessingBarMessage="processingError"):(cached.$processingBar.html(getText("processingActions")).removeClass("drgrpg-processingBar--error"),currentProcessingBarMessage="processingActions")},removeActionsTaken=function(){for(var i=0,ilen=actionsTaken.length;ilen>i;i++)for(var j=0,jlen=actionsToTake.length;jlen>j;j++)if(actionsTaken[i][0]===actionsToTake[j][0]&&actionsTaken[i][0]===actionsToTake[j][0]){actionsToTake.splice(j,1);break}actionsTaken=[]},createActionElement=function(elementType,text,action,args,id,classes){var element=document.createElement(elementType);return"button"!==elementType&&"a"!==elementType&&(element.style.cursor="pointer"),"a"===elementType&&(element.href="#/"),text&&(element.innerHTML=text),id&&(element.id=id),classes&&(element.className=classes),addEventListener(element,"click",function(){executeAction(action,args)}),element},tryAddingAction=function(action,args){for(var i=0,len=actionsToTake.length;len>i;i++)if(actionsToTake[i][0]===action&&actionsToTake[i][1]===args)return!1;return actionsToTake.push([action,args]),!0},executeAction=function(action,args){var addedAction=!1;if(action){switch(action){case"pauseButton":togglePause();break;case"huntButton":combat.round||(addedAction=tryAddingAction("combat","hunt"));break;case"fleeButton":combat.round&&(addedAction=tryAddingAction("combat","flee"),first_turn=!1,paused=!1);break;case"interactWithRoomObject":interactWithRoomObject(args[0],args[1]);break;case"movePlayer":addedAction=tryAddingAction("movePlayer",args);break;case"equip_item":addedAction=tryAddingAction("equip_item",args);break;case"unequip_item":addedAction=tryAddingAction("unequip_item",args);break;case"use_skill":addedAction=tryAddingAction("use_skill",args),paused&&togglePause();break;case"drop_item":window.confirm(getText("dropConfirmation")+args.name)&&(addedAction=tryAddingAction("drop_item",args));break;case"showRoom":combat.enemies||(displayRoom(),changeViewing("Room"));break;case"showCombat":combat.enemies?displayCombat():displayCombatButNoBattle();break;case"showItems":displayItems();break;case"showSkills":displaySkills();break;case"showAchievements":displayAchievements();break;case"roomObjectAction":addedAction=tryAddingAction("roomObjectAction",args);break;case"dismissNotification":removeNotification(args[0],args[1])}!0===addedAction&&turnsSinceLastAction>0&&1==actionsToTake.length&&!1===executingTurn?paused?"Combat"===currentlyViewing?togglePause():(paused=!1,executingTurn=!0,executeTurn()):(executingTurn=!0,executeTurn()):!0===addedAction&&0===turnsSinceLastAction&&showProcessingBar()}},generatePauseButton=function(){var button;return button=paused?createActionElement("button",getText("unpauseGame"),"pauseButton","","drgrpg-pauseButton","drgrpg-combatButtons__button drgrpg-pauseButton--paused"):createActionElement("button",getText("pauseGame"),"pauseButton","","drgrpg-pauseButton","drgrpg-combatButtons__button drgrpg-pauseButton")},togglePause=function(){!1===paused?(paused=!0,cached.$pauseButton.html(getText("unpauseGame")).attr("class","drgrpg-combatButtons__button drgrpg-pauseButton--paused")):(paused=!1,cached.$pauseButton.html(getText("pauseGame")).attr("class","drgrpg-combatButtons__button drgrpg-pauseButton"),turnsSinceLastAction>0&&executeTurn())},addEventListener=function(element,eventName,handler){element.addEventListener?element.addEventListener(eventName,handler):element.attachEvent("on"+eventName,function(){handler.call(element)})},emptyElement=function(element){for(;element.firstChild;)element.removeChild(element.firstChild)},fadeHTMLFragment=function(element,fragment,callback){!1==element instanceof jQuery&&(element=$(element)),fragment=sanitizeFragment(fragment),element.animate({opacity:0},200,function(){emptyElement(element[0]),element[0].appendChild(fragment),element.animate({opacity:1},200),callback&&callback()})},sanitizeFragment=function(raw){for(var scripts,length,temp=document.createElement("div");raw.firstChild;)temp.appendChild(raw.firstChild);for(scripts=temp.getElementsByTagName("script"),length=scripts.length;length--;)scripts[length].parentNode.removeChild(scripts[length]);for(;temp.firstChild;)raw.appendChild(temp.firstChild);return raw},convertStringToFragment=function(raw){var frag=document.createDocumentFragment(),holder=document.createElement("div");for(holder.innerHTML=raw;holder.firstChild;)frag.appendChild(holder.firstChild);return frag},addCommas=function(number){for(number=number.toString();/(\d+)(\d{3})/.test(number);)number=number.replace(/(\d+)(\d{3})/,"$1,$2");return number},pickRandomMessage=function(anArray){var randomIndex,typeOfRandomlySelected,typeOfArg=typeof anArray;return"object"===typeOfArg&&"[object Array]"===Object.prototype.toString.call(anArray)&&(typeOfArg="array"),"array"!==typeOfArg?"string"===typeOfArg?anArray:"You must pass a string or an array.":(randomIndex=Math.floor(Math.random()*anArray.length),typeOfRandomlySelected=typeof anArray[randomIndex],"string"===typeOfRandomlySelected?anArray[randomIndex]:"function"===typeOfRandomlySelected?"null":void 0)},refreshGameScreen=function(){displayMainMenu(),"Room"===currentlyViewing?displayRoom():"Combat"===currentlyViewing?displayCombat():"Items"===currentlyViewing?displayItems():"Skills"===currentlyViewing?displaySkills():"Achievements"===currentlyViewing&&displayAchievements(),displayPlayerStats(),displayPlayerIdentity()},updateTranslation=function(newTranslation){pendingTranslation=newTranslation},processTranslation=function(){var typeOfValue;for(var key in pendingTranslation)if(pendingTranslation.hasOwnProperty(key))if(typeOfValue=typeof pendingTranslation[key],"object"===typeOfValue&&"[object Array]"===Object.prototype.toString.call(pendingTranslation[key])&&(typeOfValue="array"),"string"===typeOfValue||"array"===typeOfValue)config.language[key]=pendingTranslation[key];else if("function"===typeOfValue)continue;pendingTranslation=null,refreshGameScreen()},getText=function(text){var typeOfValue;return config.language[text]?(typeOfValue=typeof config.language[text],"object"===typeOfValue&&"[object Array]"===Object.prototype.toString.call(config.language[text])&&(typeOfValue="array"),"string"===typeOfValue?config.language[text]:"array"===typeOfValue?pickRandomMessage(config.language[text]):"null"):""},doAction=function(name){name&&hooks[name]&&"function"==typeof hooks[name]&&hooks[name]()},addAction=function(name,func){name&&func&&"function"==typeof func&&(hooks[name]=func)},init=function(){!0!==initialized&&(initialized=!0,cacheSelectors(),addMissingElements(),fillElementsWithText(),displayMainMenu(),executeTurn(),doAction("init"))};return{getSelectors:function(){return cached},init:init,updateTranslation:updateTranslation,addAction:addAction}}(jQuery);"1"===infoFromServer.autostart&&jQuery(document).ready(DRGRPG.init);